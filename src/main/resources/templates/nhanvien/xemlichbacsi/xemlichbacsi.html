<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Xem L·ªãch B√°c Sƒ©</title>
	<link rel="stylesheet" th:href="@{/css/xemlichbacsi.css}">
	<link rel="stylesheet" th:href="@{/css/headerbenhnhan.css}">
</head>

<body>
	<!-- Header nh√¢n vi√™n -->
	<div th:replace="~{nhanvien/fragments/header :: header}"></div>

	<div class="container">
		<!-- Th√¥ng b√°o t√πy ch·ªânh -->
		<div class="notification" id="notification" style="display: none;"></div>

		<h1>Xem L·ªãch L√†m Vi·ªác C·ªßa B√°c Sƒ©</h1>

		<!-- Ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y -->
		<div class="doctor-select">
			<select id="chuyenKhoaSelect" onchange="loadDoctorsBySpecialty()">
				<option value="">Ch·ªçn chuy√™n khoa</option>
				<option th:each="chuyenKhoa : ${chuyenKhoaList}" th:value="${chuyenKhoa.chuyenKhoaId}"
					th:text="${chuyenKhoa.ten}"></option>
			</select>

			<select id="doctorSelect" onchange="loadSchedule()">
				<option value="">Ch·ªçn b√°c sƒ©</option>
			</select>

			<input type="date" id="dateSelect" onchange="loadSchedule()" />
		</div>

		<!-- Ph√¢n trang theo ca kh√°m -->
		<div class="pagination-controls">
			<!-- N√∫t ph√¢n trang s·∫Ω hi·ªÉn th·ªã theo d·ªØ li·ªáu -->
			<div id="paginationButtons"></div>
		</div>

		<!-- B·∫£ng l·ªãch kh√°m -->
		<table class="schedule-table" id="scheduleTable">
			<thead>
				<tr>
					<th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
					<th>Gi·ªù k·∫øt th√∫c</th>
					<th>Tr·∫°ng th√°i</th>
					<th>T√™n b·ªánh nh√¢n</th>
					<th>S·ªë ƒëi·ªán tho·∫°i</th>
				</tr>
			</thead>
			<tbody id="scheduleBody">
				<tr>
					<td colspan="5" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- Script -->
	<script>
		let fullScheduleData = [];
		let availableCaList = [];

		function loadDoctorsBySpecialty() {
			const chuyenKhoaId = document.getElementById('chuyenKhoaSelect').value;
			const doctorSelect = document.getElementById('doctorSelect');
			const tbody = document.getElementById('scheduleBody');

			doctorSelect.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
			tbody.innerHTML = '<tr><td colspan="5" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td></tr>';

			if (!chuyenKhoaId) {
				doctorSelect.innerHTML = '<option value="">Ch·ªçn b√°c sƒ©</option>';
				return;
			}

			fetch('/nhanvien/xemlichbacsi/doctors-by-specialty?chuyenKhoaId=' + chuyenKhoaId)
				.then(response => response.json())
				.then(data => {
					doctorSelect.innerHTML = '<option value="">Ch·ªçn b√°c sƒ©</option>';
					if (!Array.isArray(data) || data.length === 0) {
						doctorSelect.innerHTML = '<option value="">Kh√¥ng c√≥ b√°c sƒ© trong chuy√™n khoa n√†y</option>';
						return;
					}
					data.forEach(doctor => {
						const option = document.createElement('option');
						option.value = doctor.bacSiId;
						option.textContent = doctor.ten;
						doctorSelect.appendChild(option);
					});
				})
				.catch(error => {
					console.error('L·ªói:', error);
					doctorSelect.innerHTML = '<option value="">ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch b√°c sƒ©</option>';
				});
		}

		function loadSchedule() {
			const doctorId = document.getElementById('doctorSelect').value;
			const selectedDate = document.getElementById('dateSelect').value;
			const tbody = document.getElementById('scheduleBody');

			if (!doctorId || !selectedDate) {
				tbody.innerHTML = '<tr><td colspan="5" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td></tr>';
				return;
			}

			fetch(`/nhanvien/xemlichbacsi/schedule?doctorId=${doctorId}&date=${selectedDate}`)
				.then(response => response.json())
				.then(data => {
					fullScheduleData = data;
					availableCaList = [...new Set(data.map(item => item.caKham))];
					createPaginationButtons();
					if (availableCaList.length > 0) {
						showPage(availableCaList[0]);
					} else {
						tbody.innerHTML = '<tr><td colspan="5" class="no-data">Kh√¥ng c√≥ l·ªãch kh√°m cho b√°c sƒ© trong ng√†y n√†y</td></tr>';
					}
				})
				.catch(error => {
					console.error('Error:', error);
					tbody.innerHTML = '<tr><td colspan="5" class="no-data">ƒê√£ x·∫£y ra l·ªói khi t·∫£i l·ªãch</td></tr>';
				});
		}

		function createPaginationButtons() {
			const paginationContainer = document.getElementById('paginationButtons');
			paginationContainer.innerHTML = '';
			availableCaList.forEach(ca => {
				const button = document.createElement('button');
				button.textContent = 'Ca ' + ca;
				button.onclick = () => showPage(ca);
				paginationContainer.appendChild(button);
			});
		}

		function showPage(ca) {
			const tbody = document.getElementById('scheduleBody');
			tbody.innerHTML = '';

			// Khung gi·ªù m·∫∑c ƒë·ªãnh cho t·ª´ng ca
			const khungGioCa = {
				"S√°ng": ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
				"Chi·ªÅu": ["13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30"],
				"Ngo√†i Gi·ªù": ["17:00", "17:30", "18:00", "18:30", "19:00", "19:30"]
			};

			// C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho c√°c n√∫t
			const buttons = document.querySelectorAll('.pagination-controls button');
			buttons.forEach(btn => {
				btn.classList.toggle('active', btn.textContent === 'Ca ' + ca);
			});

			const timeSlots = khungGioCa[ca];
			if (!timeSlots) {
				tbody.innerHTML = `<tr><td colspan="5" class="no-data">Kh√¥ng c√≥ khung gi·ªù m·∫∑c ƒë·ªãnh cho ca ${ca}</td></tr>`;
				return;
			}

			// T·∫°o map t·ª´ gi·ªù b·∫Øt ƒë·∫ßu -> th√¥ng tin slot
			const slotMap = {};
			fullScheduleData
				.filter(item => item.caKham === ca && item.thoiGianBatDau !== "---")
				.forEach(item => {
					slotMap[item.thoiGianBatDau] = item;
				});

			// L·∫•y th√¥ng tin doctorId v√† date t·ª´ c√°c input
			const doctorId = document.getElementById('doctorSelect').value;
			const selectedDate = document.getElementById('dateSelect').value;

			// Duy·ªát qua khung gi·ªù m·∫∑c ƒë·ªãnh
			for (let i = 0; i < timeSlots.length - 1; i++) {
				const start = timeSlots[i];
				const end = timeSlots[i + 1];
				const slot = slotMap[start];

				const row = document.createElement('tr');
				if (slot) {
					// N·∫øu ƒë√£ c√≥ slot, hi·ªÉn th·ªã tr·∫°ng th√°i v√† th√¥ng tin b·ªánh nh√¢n
					if (slot.trangThai === "ƒê√£ ƒë·∫∑t"||slot.trangThai=="ƒêang ch·ªù") {
						row.innerHTML = `
                        <td>${start}</td>
                        <td>${end}</td>
                        <td>
                            ${slot.trangThai}
                            <button class="checkin-btn" onclick="checkInPatient('${slot.slotId}', '${ca}')">
                                Check-in
                            </button>
                        </td>
                        <td>${slot.tenBenhNhan}</td>
                        <td>${slot.soDienThoai}</td>
                    `;
					} else if (slot.trangThai === "ƒê√£ kh√°m xong") {
						row.innerHTML = `
                        <td>${start}</td>
                        <td>${end}</td>
                        <td>
                            <span class="checked-in">‚úÖ ${slot.trangThai}</span>
                        </td>
                        <td>${slot.tenBenhNhan}</td>
                        <td>${slot.soDienThoai}</td>
                    `;
					} else if (slot.trangThai === "ƒêang kh√°m") {
						row.innerHTML = `
	<td>${start}</td>
	<td>${end}</td>
	<td><span class="status-in-progress">ü©∫ ${slot.trangThai}</span></td>
	<td>${slot.tenBenhNhan}</td>
	<td>${slot.soDienThoai}</td>
	`;
					} else if (slot.trangThai === "ƒê√£ h·ªßy") {
						row.innerHTML = `
	<td>${start}</td>
	<td>${end}</td>
	<td><span class="status-cancelled">‚ùå ${slot.trangThai}</span></td>
	<td>${slot.tenBenhNhan}</td>
	<td>${slot.soDienThoai}</td>
	`;
					} else {
						row.innerHTML = `
	<td>${start}</td>
	<td>${end}</td>
	<td>${slot.trangThai}</td>
	<td>${slot.tenBenhNhan}</td>
	<td>${slot.soDienThoai}</td>
	`;
					}

				} else {
					// N·∫øu ch∆∞a c√≥ slot, th√™m n√∫t "ƒêƒÉng k√Ω"
					row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td>
                        Ch∆∞a c√≥ slot
                        <button class="register-btn" onclick="redirectToRegister('${doctorId}', '${selectedDate}', '${ca}', '${start}')">
                            ƒêƒÉng k√Ω
                        </button>
                    </td>
                    <td>---</td>
                    <td>---</td>
                `;
				}
				tbody.appendChild(row);
			}
		}

		function showNotification(message, type) {
			const notification = document.getElementById('notification');
			if (!notification) {
				console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ notification!');
				return;
			}
			notification.innerHTML = type === 'success' ? `‚úÖ ${message}` : `‚ùå ${message}`;
			notification.className = `notification ${type}`;
			notification.style.display = 'block';

			// T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
			setTimeout(() => {
				notification.style.display = 'none';
			}, 2000);
		}

		function checkInPatient(slotId, ca) {
			fetch(`/nhanvien/xemlichbacsi/checkin?slotId=${slotId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng: ' + response.statusText);
					}
					return response.json();
				})
				.then(data => {
					if (data.status === 'success') {
						showNotification(data.message, 'success');
						// ƒê·ª£i th√¥ng b√°o hi·ªÉn th·ªã xong r·ªìi m·ªõi l√†m m·ªõi b·∫£ng
						setTimeout(() => {
							loadSchedule();
							showPage(ca);
						}, 3000); // ƒê·ª£i 3 gi√¢y (b·∫±ng th·ªùi gian hi·ªÉn th·ªã th√¥ng b√°o)
					} else {
						showNotification(data.message, 'error');
					}
				})
				.catch(error => {
					console.error('L·ªói:', error);
					showNotification('ƒê√£ x·∫£y ra l·ªói khi check-in!', 'error');
				});
		}

		function redirectToRegister(doctorId, date, ca, startTime) {
			// L∆∞u d·ªØ li·ªáu v√†o sessionStorage
			sessionStorage.setItem('doctorId', doctorId);
			sessionStorage.setItem('selectedDate', date);
			sessionStorage.setItem('selectedCa', ca);
			sessionStorage.setItem('selectedTime', startTime);

			// L·∫•y th√¥ng tin b√°c sƒ© ƒë·ªÉ l∆∞u t√™n v√† chuy√™n khoa
			fetch(`/nhanvien/xemlichbacsi/doctors-by-specialty?chuyenKhoaId=0`)
				.then(response => response.json())
				.then(data => {
					const doctor = data.find(d => d.bacSiId === doctorId);
					if (doctor) {
						sessionStorage.setItem('doctorName', doctor.ten);
						sessionStorage.setItem('doctorSpecialty', doctor.chuyenKhoa.ten);
					}
					// T·∫°o URL v·ªõi c√°c tham s·ªë v√† chuy·ªÉn h∆∞·ªõng
					const url = `/nhanvien/dangkylichkham/buoc4?doctorId=${doctorId}&date=${date}&ca=${ca}&startTime=${startTime}`;
					window.location.href = url;
				})
				.catch(error => {
					console.error('L·ªói khi l·∫•y th√¥ng tin b√°c sƒ©:', error);
					// N·∫øu c√≥ l·ªói, v·∫´n chuy·ªÉn h∆∞·ªõng nh∆∞ng kh√¥ng c√≥ th√¥ng tin b√°c sƒ©
					const url = `/nhanvien/dangkylichkham/buoc4?doctorId=${doctorId}&date=${date}&ca=${ca}&startTime=${startTime}`;
					window.location.href = url;
				});
		}
	</script>
	<script>
	// H√†m l·∫•y ca hi·ªán t·∫°i ƒëang hi·ªÉn th·ªã (d·ª±a tr√™n n√∫t ƒëang active)
	function getCurrentCa() {
		const activeButton = document.querySelector('.pagination-controls button.active');
		if (activeButton) {
			return activeButton.textContent.replace('Ca ', '').trim();
		}
		return null;
	}

	// C·∫≠p nh·∫≠t l·ªãch ƒë·ªãnh k·ª≥ m·ªói 10 gi√¢y
	setInterval(() => {
		const currentCa = getCurrentCa();
		if (currentCa) {
			loadSchedule(); // G·ªçi l·∫°i API ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu fullScheduleData
			setTimeout(() => {
				showPage(currentCa); // Sau khi load xong th√¨ hi·ªÉn th·ªã l·∫°i ƒë√∫ng ca ƒëang xem
			}, 300); // ƒë·ª£i m·ªôt ch√∫t cho d·ªØ li·ªáu k·ªãp c·∫≠p nh·∫≠t
		}
	}, 5000); // 10000ms = 10 gi√¢y
</script>

</body>

</html>