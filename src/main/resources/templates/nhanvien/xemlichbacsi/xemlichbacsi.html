<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Xem L·ªãch B√°c Sƒ©</title>
	<link rel="stylesheet" th:href="@{/css/xemlichbacsi.css}">
	<link rel="stylesheet" th:href="@{/css/headerbenhnhan.css}">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
	<!-- Header nh√¢n vi√™n -->
	<div th:replace="~{nhanvien/fragments/header :: header}"></div>

	<div class="container">
		<h1>Xem L·ªãch L√†m Vi·ªác C·ªßa B√°c Sƒ©</h1>

		<!-- Ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y -->
		<div class="doctor-select">
			<select id="chuyenKhoaSelect" onchange="loadDoctorsBySpecialty()">
				<option value="">Ch·ªçn chuy√™n khoa</option>
				<option th:each="chuyenKhoa : ${chuyenKhoaList}" th:value="${chuyenKhoa.chuyenKhoaId}"
					th:text="${chuyenKhoa.ten}"></option>
			</select>

			<select id="doctorSelect" onchange="loadSchedule()">
				<option value="">Ch·ªçn b√°c sƒ©</option>
			</select>

			<input type="date" id="dateSelect" onchange="loadSchedule()" />
		</div>

		<!-- Ph√¢n trang theo ca kh√°m -->
		<div class="pagination-controls">
			<div id="paginationButtons"></div>
		</div>

		<!-- B·∫£ng l·ªãch kh√°m -->
		<table class="schedule-table" id="scheduleTable">
			<thead>
				<tr>
					<th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
					<th>Gi·ªù k·∫øt th√∫c</th>
					<th>Tr·∫°ng th√°i</th>
					<th>T√™n b·ªánh nh√¢n</th>
					<th>S·ªë ƒëi·ªán tho·∫°i</th>
					<th>Thanh to√°n</th>
				</tr>
			</thead>
			<tbody id="scheduleBody">
				<tr>
					<td colspan="6" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- Modal thanh to√°n -->
	<div id="paymentModal" class="modal">
		<div class="modal-content">
			<span class="close">√ó</span>
			<h2>Chi Ti·∫øt Thanh To√°n</h2>
			<div id="paymentDetails">
				<!-- Th√¥ng tin h·ªì s∆° b·ªánh -->
				<h3>H·ªì S∆° B·ªánh</h3>
				<table class="detail-table">
					<tr>
						<th>Ch·∫©n ƒëo√°n</th>
						<td id="chanDoan">---</td>
					</tr>
					<tr>
						<th>Tri·ªáu ch·ª©ng</th>
						<td id="trieuChung">---</td>
					</tr>

				</table>

				<!-- Danh s√°ch ƒë∆°n thu·ªëc -->
				<h3>ƒê∆°n Thu·ªëc</h3>
				<table class="detail-table" id="donThuocTable">
					<thead>
						<tr>
							<th>T√™n thu·ªëc</th>
							<th>S·ªë l∆∞·ª£ng</th>
							<th>Li·ªÅu d√πng</th>
							<th>T·∫ßn su·∫•t</th>
							<th>Gi√°</th>
						</tr>
					</thead>
					<tbody id="donThuocBody">
						<tr>
							<td colspan="5" class="no-data">Kh√¥ng c√≥ ƒë∆°n thu·ªëc</td>
						</tr>
					</tbody>
				</table>

				<!-- Danh s√°ch phi·∫øu x√©t nghi·ªám -->
				<h3>Phi·∫øu X√©t Nghi·ªám</h3>
				<table class="detail-table" id="phieuXetNghiemTable">
					<thead>
						<tr>
							<th>T√™n x√©t nghi·ªám</th>
							<th>Gi√° (VNƒê)</th>
						</tr>
					</thead>
					<tbody id="phieuXetNghiemBody">
						<tr>
							<td colspan="2" class="no-data">Kh√¥ng c√≥ x√©t nghi·ªám</td>
						</tr>
					</tbody>
				</table>

				<!-- T·ªïng ti·ªÅn -->
				<div class="total">
					<strong>T·ªïng ti·ªÅn:</strong>
					<span id="tongTien">0 VNƒê</span>
				</div>
			</div>
			<div class="modal-footer">
				<button id="confirmPaymentBtn" class="payment-btn">X√°c nh·∫≠n thanh to√°n</button>
				<button id="cancelPaymentBtn" class="cancel-btn">H·ªßy</button>
			</div>
		</div>
	</div>

	<!-- Script -->
	<script>
		let fullScheduleData = [];
		let availableCaList = [];
		let currentSlotId = null;
		let currentCa = null;
		let currentHoSoId = null;

		function loadDoctorsBySpecialty() {
			const chuyenKhoaId = document.getElementById('chuyenKhoaSelect').value;
			const doctorSelect = document.getElementById('doctorSelect');
			const tbody = document.getElementById('scheduleBody');

			doctorSelect.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
			tbody.innerHTML = '<tr><td colspan="6" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td></tr>';

			if (!chuyenKhoaId) {
				doctorSelect.innerHTML = '<option value="">Ch·ªçn b√°c sƒ©</option>';
				return;
			}

			fetch('/nhanvien/xemlichbacsi/doctors-by-specialty?chuyenKhoaId=' + chuyenKhoaId)
				.then(response => response.json())
				.then(data => {
					doctorSelect.innerHTML = '<option value="">Ch·ªçn b√°c sƒ©</option>';
					if (!Array.isArray(data) || data.length === 0) {
						doctorSelect.innerHTML = '<option value="">Kh√¥ng c√≥ b√°c sƒ© trong chuy√™n khoa n√†y</option>';
						return;
					}
					data.forEach(doctor => {
						const option = document.createElement('option');
						option.value = doctor.bacSiId;
						option.textContent = doctor.ten;
						doctorSelect.appendChild(option);
					});
				})
				.catch(error => {
					console.error('L·ªói:', error);
					doctorSelect.innerHTML = '<option value="">ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch b√°c sƒ©</option>';
					Swal.fire({
						icon: 'error',
						title: 'L·ªói',
						text: 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√°c sƒ©!',
					});
				});
		}

		function loadSchedule() {
			const doctorId = document.getElementById('doctorSelect').value;
			const selectedDate = document.getElementById('dateSelect').value;
			const tbody = document.getElementById('scheduleBody');

			if (!doctorId || !selectedDate) {
				tbody.innerHTML = '<tr><td colspan="6" class="no-data">Vui l√≤ng ch·ªçn chuy√™n khoa, b√°c sƒ© v√† ng√†y ƒë·ªÉ xem l·ªãch</td></tr>';
				return;
			}

			fetch(`/nhanvien/xemlichbacsi/schedule?doctorId=${doctorId}&date=${selectedDate}`)
				.then(response => response.json())
				.then(data => {
					fullScheduleData = data;
					availableCaList = [...new Set(data.map(item => item.caKham))];
					createPaginationButtons();
					if (availableCaList.length > 0) {
						showPage(availableCaList[0]);
					} else {
						tbody.innerHTML = '<tr><td colspan="6" class="no-data">Kh√¥ng c√≥ l·ªãch kh√°m cho b√°c sƒ© trong ng√†y n√†y</td></tr>';
					}
				})
				.catch(error => {
					console.error('Error:', error);
					tbody.innerHTML = '<tr><td colspan="6" class="no-data">ƒê√£ x·∫£y ra l·ªói khi t·∫£i l·ªãch</td></tr>';
					Swal.fire({
						icon: 'error',
						title: 'L·ªói',
						text: 'Kh√¥ng th·ªÉ t·∫£i l·ªãch kh√°m!',
					});
				});
		}

		function createPaginationButtons() {
			const paginationContainer = document.getElementById('paginationButtons');
			paginationContainer.innerHTML = '';
			availableCaList.forEach(ca => {
				const button = document.createElement('button');
				button.textContent = 'Ca ' + ca;
				button.onclick = () => showPage(ca);
				paginationContainer.appendChild(button);
			});
		}

		function showPage(ca) {
			const tbody = document.getElementById('scheduleBody');
			tbody.innerHTML = '';

			const khungGioCa = {
				"S√°ng": ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
				"Chi·ªÅu": ["13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30"],
				"Ngo√†i Gi·ªù": ["17:00", "17:30", "18:00", "18:30", "19:00", "19:30"]
			};

			const buttons = document.querySelectorAll('.pagination-controls button');
			buttons.forEach(btn => {
				btn.classList.toggle('active', btn.textContent === 'Ca ' + ca);
			});

			const timeSlots = khungGioCa[ca];
			if (!timeSlots) {
				tbody.innerHTML = `<tr><td colspan="6" class="no-data">Kh√¥ng c√≥ khung gi·ªù m·∫∑c ƒë·ªãnh cho ca ${ca}</td></tr>`;
				return;
			}

			const slotMap = {};
			fullScheduleData
				.filter(item => item.caKham === ca && item.thoiGianBatDau !== "---")
				.forEach(item => {
					slotMap[item.thoiGianBatDau] = item;
				});

			const doctorId = document.getElementById('doctorSelect').value;
			const selectedDate = document.getElementById('dateSelect').value;

			for (let i = 0; i < timeSlots.length - 1; i++) {
				const start = timeSlots[i];
				const end = timeSlots[i + 1];
				const slot = slotMap[start];

				const row = document.createElement('tr');
				if (slot) {
					if (slot.trangThai === "ƒê√£ ƒë·∫∑t" || slot.trangThai === "ƒêang ch·ªù") {
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td>
                        ${slot.trangThai}
                        <button class="checkin-btn" onclick="checkInPatient('${slot.slotId}', '${ca}')">
                            Check-in
                        </button>
                    </td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>-</td>
                `;
					} else if (slot.trangThai === "ƒê√£ kh√°m xong") {
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td>
                        <span class="checked-in">‚úÖ ${slot.trangThai}</span>
                    </td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>
                        <button class="payment-btn" onclick="showPaymentModal('${slot.slotId}', '${ca}')">
                            Thanh to√°n
                        </button>
                    </td>
                `;
					} else if (slot.trangThai === "ƒêang kh√°m") {
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td><span class="status-in-progress">ü©∫ ${slot.trangThai}</span></td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>-</td>
                `;
					} else if (slot.trangThai === "ƒê√£ h·ªßy") {
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td><span class="status-cancelled">‚ùå ${slot.trangThai}</span></td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>-</td>
                `;
					} else if (slot.trangThai === "completed") { // Thay "ƒê√£ thanh to√°n" b·∫±ng "Completed"
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td><span class="status-paid">üí≥ ${slot.trangThai}</span></td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>-</td>
                `;
					} else {
						row.innerHTML = `
                    <td>${start}</td>
                    <td>${end}</td>
                    <td>${slot.trangThai}</td>
                    <td>${slot.tenBenhNhan}</td>
                    <td>${slot.soDienThoai}</td>
                    <td>-</td>
                `;
					}
				} else {
					row.innerHTML = `
                <td>${start}</td>
                <td>${end}</td>
                <td>
                    Ch∆∞a c√≥ slot
                    <button class="register-btn" onclick="redirectToRegister('${doctorId}', '${selectedDate}', '${ca}', '${start}')">
                        ƒêƒÉng k√Ω
                    </button>
                </td>
                <td>---</td>
                <td>---</td>
                <td>-</td>
            `;
				}
				tbody.appendChild(row);
			}
		}

		function showPaymentModal(slotId, ca) {
			currentSlotId = slotId;
			currentCa = ca;
			const modal = document.getElementById('paymentModal');
			const chanDoan = document.getElementById('chanDoan');
			const trieuChung = document.getElementById('trieuChung');
			const donThuocBody = document.getElementById('donThuocBody');
			const phieuXetNghiemBody = document.getElementById('phieuXetNghiemBody');
			const tongTien = document.getElementById('tongTien');
			const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');

			// Reset n·ªôi dung
			chanDoan.textContent = '---';
			trieuChung.textContent = '---';
			donThuocBody.innerHTML = '<tr><td colspan="5" class="no-data">Kh√¥ng c√≥ ƒë∆°n thu·ªëc</td></tr>';
			phieuXetNghiemBody.innerHTML = '<tr><td colspan="2" class="no-data">Kh√¥ng c√≥ x√©t nghi·ªám</td></tr>';
			tongTien.textContent = '0 VNƒê';
			confirmPaymentBtn.style.display = 'block'; // ƒê·∫£m b·∫£o n√∫t hi·ªÉn th·ªã ban ƒë·∫ßu

			// G·ªçi API ƒë·ªÉ l·∫•y chi ti·∫øt thanh to√°n
			fetch(`/nhanvien/xemlichbacsi/payment/details?slotId=${slotId}`)
				.then(response => {
					if (!response.ok) {
						throw new Error('Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng: ' + response.statusText);
					}
					return response.json();
				})
				.then(data => {
					if (!data) {
						Swal.fire({
							icon: 'error',
							title: 'L·ªói',
							text: 'Kh√¥ng t√¨m th·∫•y chi ti·∫øt thanh to√°n!',
						});
						return;
					}

					currentHoSoId = data.hoSoId;

					// C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆° b·ªánh
					chanDoan.textContent = data.chanDoan || 'Kh√¥ng c√≥ ch·∫©n ƒëo√°n';
					trieuChung.textContent = data.trieuChung || 'Kh√¥ng c√≥ tri·ªáu ch·ª©ng';

					// T√≠nh ti·ªÅn kh√°m (t·ªïng ti·ªÅn tr·ª´ gi√° thu·ªëc v√† x√©t nghi·ªám)
					let tongTienThuoc = 0;
					let tongTienXetNghiem = 0;
					if (data.thuocList && data.thuocList.length > 0) {
						tongTienThuoc = data.thuocList.reduce((sum, thuoc) => sum + (thuoc.gia * thuoc.soLuong), 0);
					}
					if (data.xetNghiemList && data.xetNghiemList.length > 0) {
						tongTienXetNghiem = data.xetNghiemList.reduce((sum, xn) => sum + xn.gia, 0);
					}

					// C·∫≠p nh·∫≠t danh s√°ch ƒë∆°n thu·ªëc
					if (data.thuocList && data.thuocList.length > 0) {
						donThuocBody.innerHTML = '';
						data.thuocList.forEach(thuoc => {
							const row = document.createElement('tr');
							row.innerHTML = `
                        <td>${thuoc.tenThuoc}</td>
                        <td>${thuoc.soLuong}</td>
                        <td>${thuoc.lieu || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                        <td>${thuoc.tanSuat || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                        <td>${(thuoc.gia * thuoc.soLuong).toLocaleString('vi-VN')} VNƒê</td>
                    `;
							donThuocBody.appendChild(row);
						});
					}

					// C·∫≠p nh·∫≠t danh s√°ch x√©t nghi·ªám
					if (data.xetNghiemList && data.xetNghiemList.length > 0) {
						phieuXetNghiemBody.innerHTML = '';
						data.xetNghiemList.forEach(xetNghiem => {
							const row = document.createElement('tr');
							row.innerHTML = `
                        <td>${xetNghiem.tenXetNghiem || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                        <td>${xetNghiem.gia.toLocaleString('vi-VN')}</td>
                    `;
							phieuXetNghiemBody.appendChild(row);
						});
					} else {
						phieuXetNghiemBody.innerHTML = '<tr><td colspan="2" class="no-data">Kh√¥ng c√≥ x√©t nghi·ªám</td></tr>';
					}

					// C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
					tongTien.textContent = data.tongTien ? data.tongTien.toLocaleString('vi-VN') + ' VNƒê' : '0 VNƒê';

					// ƒêi·ªÅu ch·ªânh n√∫t thanh to√°n d·ª±a tr√™n daThanhToan
					if (data.daThanhToan) {
						confirmPaymentBtn.disabled = true;
						confirmPaymentBtn.textContent = 'ƒê√£ thanh to√°n'; // Thay "ƒê√£ thanh to√°n" b·∫±ng "Completed"
						confirmPaymentBtn.classList.add('disabled-btn');
					} else {
						confirmPaymentBtn.disabled = false;
						confirmPaymentBtn.textContent = 'X√°c nh·∫≠n thanh to√°n';
						confirmPaymentBtn.classList.remove('disabled-btn');
					}

					// Hi·ªÉn th·ªã modal
					modal.style.display = 'block';
				})
				.catch(error => {
					console.error('L·ªói:', error);
					Swal.fire({
						icon: 'error',
						title: 'L·ªói',
						text: 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i chi ti·∫øt thanh to√°n!',
					});
				});
		}

		function processPayment() {
			fetch(`/nhanvien/xemlichbacsi/payment/confirm?hoSoId=${currentHoSoId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng: ' + response.statusText);
					}
					return response.json();
				})
				.then(data => {
					if (data.status === 'success') {
						Swal.fire({
							icon: 'success',
							title: 'Th√†nh c√¥ng',
							text: data.message,
							timer: 1500,
							showConfirmButton: false
						});
						document.getElementById('paymentModal').style.display = 'none';
						setTimeout(() => {
							loadSchedule();
							showPage(currentCa); // L√†m m·ªõi trang ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i slot
						}, 1500);
					} else {
						Swal.fire({
							icon: 'error',
							title: 'L·ªói',
							text: data.message,
						});
					}
				})
				.catch(error => {
					console.error('L·ªói:', error);
					Swal.fire({
						icon: 'error',
						title: 'L·ªói',
						text: 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω thanh to√°n!',
					});
				});
		}

		function checkInPatient(slotId, ca) {
			fetch(`/nhanvien/xemlichbacsi/checkin?slotId=${slotId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng: ' + response.statusText);
					}
					return response.json();
				})
				.then(data => {
					if (data.status === 'success') {
						Swal.fire({
							icon: 'success',
							title: 'Th√†nh c√¥ng',
							text: data.message,
							timer: 1500,
							showConfirmButton: false
						});
						setTimeout(() => {
							loadSchedule();
							showPage(ca);
						}, 1500);
					} else {
						Swal.fire({
							icon: 'error',
							title: 'L·ªói',
							text: data.message,
						});
					}
				})
				.catch(error => {
					console.error('L·ªói:', error);
					Swal.fire({
						icon: 'error',
						title: 'L·ªói',
						text: 'ƒê√£ x·∫£y ra l·ªói khi check-in!',
					});
				});
		}

		function redirectToRegister(doctorId, date, ca, startTime) {
			sessionStorage.setItem('doctorId', doctorId);
			sessionStorage.setItem('selectedDate', date);
			sessionStorage.setItem('selectedCa', ca);
			sessionStorage.setItem('selectedTime', startTime);

			fetch(`/nhanvien/xemlichbacsi/doctors-by-specialty?chuyenKhoaId=0`)
				.then(response => response.json())
				.then(data => {
					const doctor = data.find(d => d.bacSiId === doctorId);
					if (doctor) {
						sessionStorage.setItem('doctorName', doctor.ten);
						sessionStorage.setItem('doctorSpecialty', doctor.chuyenKhoa.ten);
					}
					const url = `/nhanvien/dangkylichkham/buoc4?doctorId=${doctorId}&date=${date}&ca=${ca}&startTime=${startTime}`;
					window.location.href = url;
				})
				.catch(error => {
					console.error('L·ªói khi l·∫•y th√¥ng tin b√°c sƒ©:', error);
					const url = `/nhanvien/dangkylichkham/buoc4?doctorId=${doctorId}&date=${date}&ca=${ca}&startTime=${startTime}`;
					window.location.href = url;
				});
		}

		// H√†m l·∫•y ca hi·ªán t·∫°i ƒëang hi·ªÉn th·ªã
		function getCurrentCa() {
			const activeButton = document.querySelector('.pagination-controls button.active');
			if (activeButton) {
				return activeButton.textContent.replace('Ca ', '').trim();
			}
			return null;
		}

		// C·∫≠p nh·∫≠t l·ªãch ƒë·ªãnh k·ª≥ m·ªói 5 gi√¢y
		setInterval(() => {
			const currentCa = getCurrentCa();
			if (currentCa) {
				loadSchedule();
				setTimeout(() => {
					showPage(currentCa);
				}, 300);
			}
		}, 5000);

		// X·ª≠ l√Ω modal
		const modal = document.getElementById('paymentModal');
		const closeModal = document.getElementsByClassName('close')[0];
		const cancelBtn = document.getElementById('cancelPaymentBtn');
		const confirmBtn = document.getElementById('confirmPaymentBtn');

		closeModal.onclick = function () {
			modal.style.display = 'none';
		};

		cancelBtn.onclick = function () {
			modal.style.display = 'none';
		};

		confirmBtn.onclick = function () {
			processPayment();
		};

		window.onclick = function (event) {
			if (event.target == modal) {
				modal.style.display = 'none';
			}
		};
	</script>
</body>

</html>