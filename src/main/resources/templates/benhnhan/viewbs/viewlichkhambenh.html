<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link th:href="@{/css/headerbenhnhan.css}" rel="stylesheet">
	<link th:href="@{/css/footerbenhnhan.css}" rel="stylesheet">
	<link th:href="@{/css/viewlichkhambenh.css}" rel="stylesheet">
	<title>Lịch Làm Việc Bác Sĩ</title>
</head>

<body>
	<div th:replace="benhnhan/fragments/header :: header"></div>

	<div class="doctor-schedule-container">
		<div class="header-banner">
			<h1>LỊCH LÀM VIỆC CỦA BÁC SĨ</h1>
		</div>

		<div class="filters">
			<select id="specialtySelect">
				<option value="">-- Chọn Chuyên Khoa --</option>
				<option th:each="chuyenKhoa : ${chuyenKhoaList}" th:value="${chuyenKhoa.chuyenKhoaId}"
					th:text="${chuyenKhoa.ten}" th:selected="${chuyenKhoa.chuyenKhoaId == selectedChuyenKhoaId}">
				</option>
			</select>
			<span class="loading" id="specialtyLoading" style="display: none;">Đang tải chuyên khoa...</span>
			<input type="date" id="datePicker" th:value="${selectedNgayThangNam}">
		</div>

		<div id="infoMessage">
			Vui lòng chọn chuyên khoa và ngày để xem lịch làm việc.
		</div>

		<table class="schedule-table">
			<thead>
				<tr>
					<th>Buổi Sáng<br>(7h30 - 11h30)</th>
					<th>Buổi Chiều<br>(13h - 16h30)</th>
					<th>Buổi Ngoài Giờ<br>(17h - 19h30)</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>
						<div th:each="lich : ${lichKhamBenhPage}">
							<div th:if="${lich.ca == 'Sáng'}">
								<div class="doctor-card">
									<a th:href="@{/chitietbacsi/{bacSiId}(bacSiId=${lich.bacSi.bacSiId})}">
										<img th:src="${lich.bacSi.urlAvatar != null ? lich.bacSi.urlAvatar : '/default-avatar.jpg'}"
											alt="Avatar">
										<span class="doctor-name" th:text="${lich.bacSi.ten}">Tên bác sĩ</span>
									</a>
									<button class="book-now-btn"
										th:attr="data-doctor-id=${lich.bacSi.bacSiId}, data-date=${selectedNgayThangNam}, data-ca='Sáng'"
										onclick="showTimeSlots(this)">
										Đặt Lịch Ngay
									</button>
								</div>
							</div>
						</div>
						<span th:if="${#lists.isEmpty(lichKhamBenhPage.?[ca == 'Sáng'])}">
							Không có bác sĩ làm việc buổi sáng.
						</span>
					</td>

					<td>
						<div th:each="lich : ${lichKhamBenhPage}">
							<div th:if="${lich.ca == 'Chiều'}">
								<div class="doctor-card">
									<a th:href="@{/chitietbacsi/{bacSiId}(bacSiId=${lich.bacSi.bacSiId})}">
										<img th:src="${lich.bacSi.urlAvatar != null ? lich.bacSi.urlAvatar : '/default-avatar.jpg'}"
											alt="Avatar">
										<span class="doctor-name" th:text="${lich.bacSi.ten}">Tên bác sĩ</span>
									</a>
									<button class="book-now-btn"
										th:attr="data-doctor-id=${lich.bacSi.bacSiId}, data-date=${selectedNgayThangNam}, data-ca='Chiều'"
										onclick="showTimeSlots(this)">
										Đặt Lịch Ngay
									</button>
								</div>
							</div>
						</div>
						<span th:if="${#lists.isEmpty(lichKhamBenhPage.?[ca == 'Chiều'])}">
							Không có bác sĩ làm việc buổi chiều.
						</span>
					</td>

					<td>
						<div th:each="lich : ${lichKhamBenhPage}">
							<div th:if="${lich.ca == 'Ngoài Giờ'}">
								<div class="doctor-card">
									<a th:href="@{/chitietbacsi/{bacSiId}(bacSiId=${lich.bacSi.bacSiId})}">
										<img th:src="${lich.bacSi.urlAvatar != null ? lich.bacSi.urlAvatar : '/default-avatar.jpg'}"
											alt="Avatar">
										<span class="doctor-name" th:text="${lich.bacSi.ten}">Tên bác sĩ</span>
									</a>
									<button class="book-now-btn"
										th:attr="data-doctor-id=${lich.bacSi.bacSiId}, data-date=${selectedNgayThangNam}, data-ca='Ngoài Giờ'"
										onclick="showTimeSlots(this)">
										Đặt Lịch Ngay
									</button>
								</div>
							</div>
						</div>
						<span th:if="${#lists.isEmpty(lichKhamBenhPage.?[ca == 'Ngoài Giờ'])}">
							Không có bác sĩ làm việc buổi ngoài giờ.
						</span>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- Modal để chọn giờ -->
	<div id="timeSlotModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeModal()">×</span>
			<h3>Chọn Giờ Khám</h3>
			<div id="timeSlotsContainer"></div>
			<div class="modal-actions">
				<button class="modal-btn modal-btn-secondary" onclick="closeModal()">Hủy</button>
				<button class="modal-btn modal-btn-primary" onclick="proceedToStep3()">Xác Nhận</button>
			</div>
		</div>
	</div>

	<div th:replace="benhnhan/fragments/footer :: footer"></div>

	<script>
		// Cập nhật giao diện ban đầu
		document.addEventListener("DOMContentLoaded", function () {
			const specialtySelect = document.getElementById("specialtySelect");
			const datePicker = document.getElementById("datePicker");
			const specialtyLoading = document.getElementById("specialtyLoading");
			const infoMessage = document.getElementById("infoMessage");

			specialtySelect.addEventListener("focus", function () {
				specialtyLoading.style.display = "inline-block";
			});

			specialtySelect.addEventListener("change", function () {
				specialtyLoading.style.display = "none";
				updateView();
			});

			datePicker.addEventListener("change", updateView);

			function updateView() {
				const selectedSpecialty = specialtySelect.value;
				const selectedDate = datePicker.value;

				if (!selectedSpecialty || !selectedDate) {
					infoMessage.style.display = "block";
				} else {
					infoMessage.style.display = "none";
					const url = `/view/schedule?chuyenKhoaId=${selectedSpecialty}&ngayThangNam=${selectedDate}`;
					window.location.href = url;
				}
			}
		});

		// Dữ liệu tạm thời để lưu thông tin khi chọn giờ
		let currentDoctorId = null;
		let currentDate = null;
		let currentCa = null;

		// Hiển thị modal chỉ khi nhấn nút đặt lịch
		function showTimeSlots(button) {
			currentDoctorId = button.getAttribute("data-doctor-id");
			currentDate = button.getAttribute("data-date");
			currentCa = button.getAttribute("data-ca");

			// Gọi API để lấy các khung giờ đã đặt
			fetch(`/user/dangkylichkham/getAvailableSlots`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({doctorId: currentDoctorId, date: currentDate})
			})
				.then(response => response.json())
				.then(data => {
					updateTimeSlots(data, currentCa);

					// Hiển thị modal chính xác khi bấm nút
					const modal = document.getElementById("timeSlotModal");
					modal.style.display = "flex";
					modal.style.opacity = "1"; // Đảm bảo hiện rõ
					modal.style.visibility = "visible";
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Đã có lỗi xảy ra, vui lòng thử lại!');
				});
		}

		// Cập nhật danh sách giờ trong modal
		function updateTimeSlots(data, ca) {
			const bookedSlots = data.bookedSlots || [];
			const timeSlotsContainer = document.getElementById("timeSlotsContainer");
			timeSlotsContainer.innerHTML = ''; // Xóa nội dung cũ

			const timeFrames = {
				"Sáng": ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
				"Chiều": ["13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30"],
				"Ngoài Giờ": ["17:00", "17:30", "18:00", "18:30", "19:00", "19:30"]
			};

			const timeSlots = timeFrames[ca];
			const timeSlotContainer = document.createElement("div");
			timeSlotContainer.classList.add("time-frame");

			const timeFrameTitle = document.createElement("h4");
			timeFrameTitle.textContent = ca;
			timeSlotContainer.appendChild(timeFrameTitle);

			timeSlots.forEach(time => {
				const isBooked = bookedSlots.includes(time);
				const label = document.createElement("label");
				const input = document.createElement("input");
				input.type = "radio";
				input.name = "time";
				input.value = time;

				if (isBooked) {
					label.style.textDecoration = 'line-through';
					input.disabled = true;
				}

				label.appendChild(input);
				label.appendChild(document.createTextNode(time));
				timeSlotContainer.appendChild(label);
			});

			timeSlotsContainer.appendChild(timeSlotContainer);
		}


		// Đóng modal khi nhấn nút hoặc bên ngoài modal
		function closeModal() {
			const modal = document.getElementById("timeSlotModal");
			modal.style.display = "none";
			modal.style.opacity = "0";
			modal.style.visibility = "hidden";
		}

		// Đảm bảo modal không hiện khi tải trang
		document.addEventListener("DOMContentLoaded", function () {
			const modal = document.getElementById("timeSlotModal");
			modal.style.display = "none";
			modal.style.opacity = "0";
			modal.style.visibility = "hidden";
		});

		// Đóng modal khi nhấp bên ngoài nội dung modal
		window.onclick = function (event) {
			const modal = document.getElementById("timeSlotModal");
			if (event.target === modal) {
				closeModal();
			}
		};
		// Chuyển đến Bước 3
		function proceedToStep3() {
			const selectedTime = document.querySelector('input[name="time"]:checked');

			if (selectedTime) {
				const selectedTimeValue = selectedTime.value;
				const url = `/user/dangkylichkham/buoc3?doctorId=${currentDoctorId}&selectedDate=${currentDate}&selectedTime=${selectedTimeValue}&ca=${currentCa}`;
				window.location.href = url;
			} else {
				alert('Vui lòng chọn giờ khám!');
			}
		}

		// Đóng modal khi nhấp bên ngoài
		window.onclick = function (event) {
			const modal = document.getElementById("timeSlotModal");
			if (event.target == modal) {
				modal.style.display = "none";
			}
		};
	</script>
</body>

</html>