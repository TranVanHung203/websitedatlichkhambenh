<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ThÃ´ng Tin BÃ¡c SÄ©</title>
	<link th:href="@{/css/headerbenhnhan.css}" rel="stylesheet">
	<link th:href="@{/css/footerbenhnhan.css}" rel="stylesheet">
	<link th:href="@{/css/chitietbs.css}" rel="stylesheet">
</head>

<body>
	<!-- Include Header -->
	<div th:replace="benhnhan/fragments/header :: header"></div>
	<div class="doctor-tabs-container">
		<!-- Avatar and Basic Info -->
		<div class="doctor-profile">
			<div class="avatar-container">
				<img th:src="@{${bacSi.urlAvatar}}" alt="áº¢nh Äáº¡i Diá»‡n BÃ¡c SÄ©" class="doctor-avatar" />
			</div>
			<div class="doctor-info">
				<h1 th:text="${bacSi.ten}">HoÃ ng LÆ°Æ¡ng</h1>
				<p><strong>ChuyÃªn Khoa:</strong> <span
						th:text="${bacSi.chuyenKhoa != null ? bacSi.chuyenKhoa.ten : ''}"></span></p>
				<p><strong>Äiá»‡n Thoáº¡i:</strong> <span
						th:text="${bacSi.dienThoai != null ? bacSi.dienThoai : ''}"></span></p>
				<p><strong>Äá»‹a Chá»‰:</strong> <span th:text="${bacSi.diaChi != null ? bacSi.diaChi : ''}"></span></p>
				<form th:action="@{/chat/bacsi}" method="get" style="display:inline;">
					<input type="hidden" name="bacSiId" th:value="${bacSi.bacSiId}" />
					<button type="submit" class="history-chat-btn">ğŸ’¬ Nháº¯n tin</button>
				</form>
			</div>
		</div>

		<!-- Tab menu -->
		<div class="tabs">
			<button class="tab-link active" onclick="openTab(event, 'basic-info')">ThÃ´ng Tin CÆ¡ Báº£n</button>
			<button class="tab-link" onclick="openTab(event, 'details-info')">ThÃ´ng Tin Chi Tiáº¿t</button>
			<button class="tab-link" onclick="openTab(event, 'schedule-info')">Lá»‹ch LÃ m Viá»‡c</button>
		</div>

		<!-- ThÃ´ng Tin CÆ¡ Báº£n -->
		<div id="basic-info" class="tab-content active">
			<h2>ThÃ´ng Tin CÆ¡ Báº£n</h2>
			<p><strong>Há» vÃ  TÃªn:</strong> <span th:text="${bacSi.ten}"></span></p>
			<p><strong>NgÃ y Sinh:</strong> <span th:text="${formattedDate}"></span></p>
			<p><strong>Giá»›i TÃ­nh:</strong> <span th:text="${bacSi.gioiTinh}"></span></p>
			<p><strong>Äiá»‡n Thoáº¡i:</strong> <span th:text="${bacSi.dienThoai}"></span></p>
			<p><strong>Äá»‹a Chá»‰:</strong> <span th:text="${bacSi.diaChi}"></span></p>
			<p><strong>ChuyÃªn Khoa:</strong> <span th:text="${bacSi.chuyenKhoa.ten}"></span></p>
		</div>

		<!-- ThÃ´ng Tin Chi Tiáº¿t -->
		<div id="details-info" class="tab-content">
			<h2>ThÃ´ng Tin Chi Tiáº¿t</h2>
			<p><strong>Báº±ng Cáº¥p:</strong> <span th:text="${bacSi.chiTietBacSi.bangCap}"></span></p>
			<p><strong>Há»™i Nghá»‹ NÆ°á»›c NgoÃ i:</strong> <span th:text="${bacSi.chiTietBacSi.hoiNghiNuocNgoai}"></span></p>
			<p><strong>Chá»©ng Chá»‰:</strong> <span th:text="${bacSi.chiTietBacSi.chungChi}"></span></p>
			<p><strong>ÄÃ o Táº¡o ChuyÃªn NgÃ nh:</strong> <span th:text="${bacSi.chiTietBacSi.daoTaoChuyenNganh}"></span>
			</p>
			<p><strong>LÄ©nh Vá»±c ChuyÃªn SÃ¢u:</strong> <span th:text="${bacSi.chiTietBacSi.linhVucChuyenSau}"></span></p>
		</div>

		<!-- Lá»‹ch LÃ m Viá»‡c -->
		<div id="schedule-info" class="tab-content">
			<h2 class="schedule-header">ğŸ“… Lá»‹ch LÃ m Viá»‡c</h2>

			<div class="date-picker-container">
				<label for="ngay">ğŸ—“ Chá»n ngÃ y:</label>
				<input type="date" id="ngay" name="ngay" th:value="${selectedDate}" class="date-picker" />
				<button type="button" class="btn-view-schedule">Xem Lá»‹ch</button>
			</div>

			<table class="schedule-table">
				<thead>
					<tr>
						<th>Ca</th>
						<th>Giá»</th>
						<th>HÃ nh Äá»™ng</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="lich : ${lichKhamBenhList}" class="schedule-row">
						<td th:text="${lich.ca}" class="shift"></td>
						<td class="time">
							<span th:if="${lich.ca == 'SÃ¡ng'}">â˜€ï¸ 07:30 - 11:30</span>
							<span th:if="${lich.ca == 'Chiá»u'}">ğŸŒ¤ 13:00 - 16:30</span>
							<span th:if="${lich.ca == 'NgoÃ i Giá»'}">ğŸŒ™ 17:00 - 19:30</span>
						</td>
						<td>
							<button class="book-now-btn"
								th:attr="data-doctor-id=${bacSi.bacSiId}, data-date=${selectedDate}, data-ca=${lich.ca}"
								onclick="showTimeSlots(this)">
								Äáº·t Lá»‹ch
							</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Modal Ä‘á»ƒ chá»n giá» -->
	<div id="timeSlotModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeModal()">Ã—</span>
			<h3>Chá»n Giá» KhÃ¡m</h3>
			<div id="timeSlotsContainer"></div>
			<div class="modal-actions">
				<button class="modal-btn modal-btn-secondary" onclick="closeModal()">Há»§y</button>
				<button class="modal-btn modal-btn-primary" onclick="proceedToStep3()">XÃ¡c Nháº­n</button>
			</div>
		</div>
	</div>
	<!-- Include Footer -->
	<div th:replace="benhnhan/fragments/footer :: footer"></div>

	<script>
		function openTab(event, tabId) {
			const tabContents = document.querySelectorAll(".tab-content");
			tabContents.forEach((content) => content.classList.remove("active"));

			const tabLinks = document.querySelectorAll(".tab-link");
			tabLinks.forEach((link) => link.classList.remove("active"));

			document.getElementById(tabId).classList.add("active");
			event.currentTarget.classList.add("active");

			const url = new URL(window.location);
			url.searchParams.set('tab', tabId);
			window.history.pushState({}, '', url);
		}

		// Handle form submission for date picker
		document.querySelector('.btn-view-schedule').addEventListener('click', function () {
			const selectedDate = document.getElementById('ngay').value;
			if (selectedDate) {
				const url = new URL(window.location);
				url.searchParams.set('ngay', selectedDate);
				url.searchParams.set('tab', 'schedule-info');
				window.location.href = url;
			} else {
				alert('Vui lÃ²ng chá»n ngÃ y!');
			}
		});

		// On page load, check for tab query parameter and activate the corresponding tab
		document.addEventListener('DOMContentLoaded', function () {
			const urlParams = new URLSearchParams(window.location.search);
			const tabId = urlParams.get('tab') || 'basic-info';
			const tabContent = document.getElementById(tabId);
			const tabLinks = document.querySelectorAll(".tab-link");

			if (tabContent) {
				document.querySelectorAll(".tab-content").forEach((content) => content.classList.remove("active"));
				tabLinks.forEach((link) => link.classList.remove("active"));

				tabContent.classList.add("active");
				const activeLink = Array.from(tabLinks).find(link => link.getAttribute('onclick').includes(tabId));
				if (activeLink) {
					activeLink.classList.add("active");
				}
			}

			// Äáº£m báº£o modal khÃ´ng hiá»‡n khi load trang
			const modal = document.getElementById("timeSlotModal");
			modal.classList.remove("show");
		});

		// Dá»¯ liá»‡u táº¡m thá»i Ä‘á»ƒ lÆ°u thÃ´ng tin khi chá»n giá»
		let currentDoctorId = null;
		let currentDate = null;
		let currentCa = null;

		// Hiá»ƒn thá»‹ modal chá»‰ khi nháº¥n nÃºt Ä‘áº·t lá»‹ch
		function showTimeSlots(button) {
			currentDoctorId = button.getAttribute("data-doctor-id");
			currentDate = button.getAttribute("data-date");
			currentCa = button.getAttribute("data-ca");

			// XÃ³a ná»™i dung cÅ© cá»§a modal trÆ°á»›c khi fetch dá»¯ liá»‡u má»›i
			const timeSlotsContainer = document.getElementById("timeSlotsContainer");
			timeSlotsContainer.innerHTML = '';

			// Gá»i API Ä‘á»ƒ láº¥y cÃ¡c khung giá» Ä‘Ã£ Ä‘áº·t
			fetch(`/user/dangkylichkham/getAvailableSlots`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({doctorId: currentDoctorId, date: currentDate})
			})
				.then(response => response.json())
				.then(data => {
					updateTimeSlots(data, currentCa);

					// Hiá»ƒn thá»‹ modal
					const modal = document.getElementById("timeSlotModal");
					modal.classList.add("show");
				})
				.catch(error => {
					console.error('Error:', error);
					alert('ÄÃ£ cÃ³ lá»—i xáº£y ra, vui lÃ²ng thá»­ láº¡i!');
				});
		}

		// Cáº­p nháº­t danh sÃ¡ch giá» trong modal
		function updateTimeSlots(data, ca) {
			const bookedSlots = data.bookedSlots || [];
			const timeSlotsContainer = document.getElementById("timeSlotsContainer");

			const timeFrames = {
				"SÃ¡ng": ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00"],
				"Chiá»u": ["13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00"],
				"NgoÃ i Giá»": ["17:00", "17:30", "18:00", "18:30", "19:00"]
			};

			const timeSlots = timeFrames[ca];
			const timeSlotContainer = document.createElement("div");
			timeSlotContainer.classList.add("time-frame");

			const timeFrameTitle = document.createElement("h4");
			timeFrameTitle.textContent = ca;
			timeSlotContainer.appendChild(timeFrameTitle);

			timeSlots.forEach(time => {
				const isBooked = bookedSlots.includes(time);
				const label = document.createElement("label");
				const input = document.createElement("input");
				input.type = "radio";
				input.name = "time";
				input.value = time;

				if (isBooked) {
					label.style.textDecoration = 'line-through';
					input.disabled = true;
				}
				label.appendChild(input);
				label.appendChild(document.createTextNode(time));
				timeSlotContainer.appendChild(label);
			});

			timeSlotsContainer.appendChild(timeSlotContainer);
		}

		// ÄÃ³ng modal vÃ  reset ná»™i dung
		function closeModal() {
			const modal = document.getElementById("timeSlotModal");
			modal.classList.remove("show");

			// Reset ná»™i dung modal
			const timeSlotsContainer = document.getElementById("timeSlotsContainer");
			timeSlotsContainer.innerHTML = '';

			// Reset lá»±a chá»n radio (náº¿u cÃ³)
			const checkedRadio = document.querySelector('input[name="time"]:checked');
			if (checkedRadio) {
				checkedRadio.checked = false;
			}
		}

		// Chuyá»ƒn Ä‘áº¿n BÆ°á»›c 3
		function proceedToStep3() {
			const selectedTime = document.querySelector('input[name="time"]:checked');

			if (selectedTime) {
				const selectedTimeValue = selectedTime.value;
				const url = `/user/dangkylichkham/buoc3?doctorId=${currentDoctorId}&selectedDate=${currentDate}&selectedTime=${selectedTimeValue}&ca=${currentCa}`;
				window.location.href = url;
			} else {
				alert('Vui lÃ²ng chá»n giá» khÃ¡m!');
			}
		}

		// ÄÃ³ng modal khi nháº¥p bÃªn ngoÃ i
		window.onclick = function (event) {
			const modal = document.getElementById("timeSlotModal");
			if (event.target === modal) {
				closeModal();
			}
		};
	</script>
</body>

</html>