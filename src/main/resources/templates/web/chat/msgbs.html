<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Chat với Bệnh Nhân</title>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
	<script>
		dayjs.extend(dayjs_plugin_relativeTime);
		let stompClient = null;
		let chatContext = { bacSiId: '', benhNhanId: '' };
		let rawContacts = [];

		function formatFriendlyTime(timestamp) {
			const now = dayjs(), time = dayjs(timestamp);
			if (!time.isValid()) return "";
			const diff = now.diff(time, 'minute');
			if (diff < 1) return "Vừa xong";
			if (diff < 60) return `${diff} phút trước`;
			if (now.isSame(time, 'day')) return `Hôm nay ${time.format("HH:mm")}`;
			if (now.subtract(1, 'day').isSame(time, 'day')) return `Hôm qua ${time.format("HH:mm")}`;
			return `${time.format("DD/MM")} ${time.format("HH:mm")}`;
		}

		function fetchContacts() {
			fetch(`/api/chat/contacts/bs?bacSiId=${chatContext.bacSiId}`)
				.then(res => res.json())
				.then(data => {
					rawContacts = data;
					applyFilters();
				});
		}

		function applyFilters() {
			const search = document.getElementById("searchInput").value.toLowerCase();
			const container = document.getElementById("contactList");
			container.innerHTML = '';

			const filtered = rawContacts.filter(p =>
				p.ten.toLowerCase().includes(search) || p.dienThoai.includes(search)
			);

			if (filtered.length === 0) {
				container.innerHTML = "<div style='padding: 8px; color: #888;'>Không tìm thấy.</div>";
				return;
			}

			filtered.forEach(p => {
				const card = document.createElement("div");
				card.className = "patient-card";
				card.innerHTML = `
					<div class="info">
						<div class="name">${p.ten}</div>
						<div class="phone">${p.dienThoai}</div>
						${p.ngayHen ? `<div class="date">Ngày hẹn: ${p.ngayHen}</div>` : ''}
					</div>`;
				card.onclick = () => {
					chatContext.benhNhanId = p.id;
					document.getElementById("chatTitle").innerText = `Đang trò chuyện với ${p.ten}`;
					loadHistory();
					connectSocket();
				};
				container.appendChild(card);
			});
		}

		function connectSocket() {
			const socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);
			stompClient.connect({}, () => {
				stompClient.subscribe('/topic/messages', (msg) => {
					const data = JSON.parse(msg.body);
					if (data.benhNhanId === chatContext.benhNhanId && data.bacSiId === chatContext.bacSiId)
						appendMessage(data, true);
				});
			});
		}

		function loadHistory() {
			fetch(`/api/chat/history?bacSiId=${chatContext.bacSiId}&benhNhanId=${chatContext.benhNhanId}`)
				.then(res => res.json())
				.then(data => {
					const container = document.getElementById("messages");
					container.innerHTML = '';
					data.forEach(m => appendMessage(m));
					container.scrollTop = container.scrollHeight;
				});
		}

		function appendMessage(msg, isNew = false) {
			const div = document.createElement("div");
			div.className = "chat-bubble " + (msg.tuBenhNhan ? "left" : "right");
			div.innerHTML = `<div class="content">${msg.noiDung}</div><div class="time">${formatFriendlyTime(msg.thoiGian)}</div>`;
			const messages = document.getElementById("messages");
			messages.appendChild(div);
			if (isNew) messages.scrollTop = messages.scrollHeight;
		}

		function sendMessage() {
			const input = document.getElementById("messageInput");
			const content = input.value.trim();
			if (!content) return;
			stompClient.send("/app/chat", {}, JSON.stringify({
				noiDung: content,
				benhNhanId: chatContext.benhNhanId,
				bacSiId: chatContext.bacSiId,
				tuBenhNhan: false
			}));
			input.value = "";
		}

		window.onload = () => {
			fetch('/api/user/info')
				.then(res => res.json())
				.then(data => {
					if (!data.isBenhNhan && data.id) {
						chatContext.bacSiId = data.id;
						fetchContacts();
					} else alert("Bạn không phải bác sĩ.");
				})
				.catch(() => alert("Không lấy được thông tin bác sĩ."));

			document.getElementById("messageInput").addEventListener("keydown", function (e) {
				if (e.key === "Enter" && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});
		};
	</script>

	<style>
		body {
			font-family: 'Segoe UI', sans-serif;
			margin: 0;
			padding: 0;
			background: #f5f5f5;
			height: 100vh;
			display: flex;
		}

		/* Sidebar */
		#sidebar {
			width: 300px;
			background: #f9fbff;
			border-right: 1px solid #ddd;
			overflow-y: auto;
			padding: 15px;
			font-size: 14px;
			box-shadow: 2px 0 5px rgba(0, 0, 0, 0.03);
		}

		#sidebar h4 {
			margin-top: 0;
			color: #007bff;
			font-size: 16px;
			margin-bottom: 12px;
		}

		#searchInput {
			width: 100%;
			padding: 8px 10px;
			border: 1px solid #ccc;
			border-radius: 6px;
			margin-bottom: 12px;
			font-size: 14px;
		}

		.patient-card {
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 8px;
			background: #ffffff;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			cursor: pointer;
			transition: all 0.2s ease;
			border-left: 4px solid #007bff;
		}

		.patient-card:hover {
			background: #e8f0ff;
			transform: translateX(2px);
		}

		.patient-card .info {
			display: flex;
			flex-direction: column;
		}

		.patient-card .name {
			font-weight: bold;
			color: #333;
			font-size: 15px;
		}

		.patient-card .phone {
			font-size: 13px;
			color: #666;
			margin-top: 3px;
		}

		.patient-card .date {
			font-size: 12px;
			color: #999;
			margin-top: 4px;
		}

		/* Chat Box */
		#chat-container {
			flex: 1;
			display: flex;
			flex-direction: column;
			padding: 10px;
		}

		#chatTitle {
			font-size: 16px;
			margin-bottom: 8px;
		}

		#messages {
			flex: 1;
			overflow-y: auto;
			background: #fff;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 8px;
			font-size: 14px;
			display: flex;
			flex-direction: column;
		}

		#input-container {
			display: flex;
			margin-top: 8px;
		}

		#messageInput {
			flex: 1;
			padding: 10px;
			border-radius: 6px;
			border: 1px solid #ccc;
			resize: none;
			font-size: 14px;
		}

		button {
			padding: 10px 16px;
			margin-left: 6px;
			background: #007bff;
			border: none;
			color: white;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
		}

		.chat-bubble {
			display: inline-block;
			max-width: 80%;
			padding: 10px 14px;
			margin: 6px 0;
			border-radius: 16px;
			background: #e6e6e6;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
			word-wrap: break-word;
			white-space: pre-wrap;
			line-height: 1.4;
			position: relative;
			animation: fadeIn 0.3s ease-in-out;
		}

		.chat-bubble.right {
			background: #007bff;
			color: white;
			margin-left: auto;
			border-bottom-right-radius: 4px;
		}

		.chat-bubble.left {
			background: #f0f0f0;
			margin-right: auto;
			border-bottom-left-radius: 4px;
		}

		.chat-bubble .time {
			font-size: 0.75em;
			color: #666;
			margin-top: 6px;
			text-align: right;
		}

		.chat-bubble.right .time {
			color: #e0e0e0;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
	</style>
</head>

<body>
	<div id="sidebar">
		<h4>Bệnh nhân</h4>
		<input type="text" id="searchInput" placeholder="Tìm theo tên hoặc số điện thoại..." oninput="applyFilters()">
		<div id="contactList">Đang tải...</div>
	</div>

	<div id="chat-container">
		<div id="chatTitle">Chọn bệnh nhân để bắt đầu</div>
		<div id="messages"></div>
		<div id="input-container">
			<textarea id="messageInput" placeholder="Nhập tin nhắn..." rows="1"></textarea>
			<button onclick="sendMessage()">Gửi</button>
		</div>
	</div>
</body>

</html>
