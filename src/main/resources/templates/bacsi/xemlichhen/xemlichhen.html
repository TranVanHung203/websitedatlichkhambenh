<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lịch Hẹn Khám Bệnh</title>
	<link rel="stylesheet" th:href="@{/css/xemlichhen.css}">
	<link rel="stylesheet" th:href="@{/css/headerbacsi.css}">
	<!-- Thêm thư viện SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<!-- Thêm Font Awesome cho icon -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<style>
		.start-exam-btn, .history-btn {
			padding: 8px 16px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			margin-left: 12px;
			font-size: 14px;
			font-weight: 500;
			transition: background-color 0.3s ease, transform 0.2s ease;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		.history-btn {
			background-color: #17a2b8;
		}
		.start-exam-btn:hover:not(:disabled), .history-btn:hover:not(:disabled) {
			background-color: #0056b3;
			transform: translateY(-1px);
		}
		.history-btn:hover:not(:disabled) {
			background-color: #138496;
		}
		.start-exam-btn:disabled {
			background-color: #d6d6d6;
			color: #6c757d;
			cursor: not-allowed;
			box-shadow: none;
		}
		.search-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 20px;
			padding: 10px;
			margin-bottom: 20px;
		}
		.reload-btn {
			padding: 8px 16px;
			background-color: #28a745;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: background-color 0.3s ease, transform 0.2s ease;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		.reload-btn:hover {
			background-color: #218838;
			transform: translateY(-1px);
		}
		.reload-btn i {
			font-size: 16px;
		}
	</style>
</head>

<body>
	<div th:replace="bacsi/fragments/header :: header"></div>

	<div class="search-bar">
		<div>
			<label for="search-date">Tìm theo ngày:</label>
			<input type="date" id="search-date" name="search-date" th:value="${date}" />
		</div>
		<div>
			<label for="search-name">Tìm theo tên:</label>
			<input type="text" id="search-name" placeholder="Nhập tên bệnh nhân..." />
		</div>
		<div>
			<label for="sort-type">Sắp xếp:</label>
			<select id="sort-type" class="sort-select">
				<option value="time-asc">Theo giờ tăng dần</option>
				<option value="time-desc">Theo giờ giảm dần</option>
				<option value="name-asc">Theo tên A-Z</option>
				<option value="name-desc">Theo tên Z-A</option>
			</select>
		</div>
		<button class="reload-btn" onclick="window.location.reload()">
			<i class="fas fa-sync-alt"></i> Tải lại
		</button>
	</div>

	<div id="appointments-container" class="appointments-container">
		<div th:each="lichKham : ${lichKhamDTOList}" class="appointment-day"
			th:attr="data-date=${lichKham.ngayThangNam},data-ma-lich-id=${lichKham.maLichKhamBenh}">
			<h3>Ca: <span th:text="${lichKham.ca}"></span> | Ngày: <span th:text="${lichKham.ngayThangNam}"></span></h3>

			<div th:each="slot : ${lichKham.slotThoiGianList}" class="appointment-card"
				th:attr="data-name=${slot.benhNhan?.ten},data-time=${slot.thoiGianBatDau},data-slot-id=${slot.slotId}">

				<div class="appointment-header">
					<h4>Thời gian: <span th:text="${slot.thoiGianBatDau}"></span> - <span
							th:text="${slot.thoiGianKetThuc}"></span></h4>
				</div>

				<div class="appointment-body">
					<p><strong>Tên bệnh nhân:</strong> <span th:text="${slot.benhNhan?.ten}">Nguyễn Văn A</span></p>
					<p><strong>Số điện thoại:</strong> <span th:text="${slot.benhNhan?.dienThoai}">0123456789</span></p>
				</div>

				<div class="appointment-footer">
					<label><strong>Trạng thái:</strong></label>
					<select class="status-select">
						<option value="pending" th:selected="${slot.trangThai == 'pending'}">Đang chờ</option>
						<option value="checked-in" th:selected="${slot.trangThai == 'checked-in'}">Đang khám</option>
						<option value="completed" th:selected="${slot.trangThai == 'completed'}">Đã khám</option>
						<option value="cancelled" th:selected="${slot.trangThai == 'cancelled'}">Đã hủy</option>
					</select>
					<button class="start-exam-btn" 
						th:disabled="${slot.trangThai != 'pending' || slot.benhNhan?.benhNhanId == null}"
						th:attr="data-benh-nhan-id=${slot.benhNhan?.benhNhanId}"
						onclick="startExamination(this)">Bắt đầu khám</button>
					<button class="history-btn" 
						th:attr="data-benh-nhan-id=${slot.benhNhan?.benhNhanId}"
						onclick="viewMedicalHistory(this)"
						th:disabled="${slot.benhNhan?.benhNhanId == null}">Xem lịch sử khám</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const searchDateInput = document.getElementById('search-date');
		const searchNameInput = document.getElementById('search-name');
		const sortTypeSelect = document.getElementById('sort-type');
		const appointmentsContainer = document.getElementById('appointments-container');

		// Filter by date and reload the page with the selected date
		searchDateInput.addEventListener('input', () => {
			const selectedDate = searchDateInput.value;
			window.location.href = `/bacsi/xemlichhen?date=${selectedDate}`;
		});

		// Filter by name
		searchNameInput.addEventListener('input', () => {
			const searchName = searchNameInput.value.toLowerCase();
			const appointmentCards = appointmentsContainer.querySelectorAll('.appointment-card');

			appointmentCards.forEach(card => {
				const patientName = card.getAttribute('data-name')?.toLowerCase() || '';
				card.style.display = patientName.includes(searchName) ? '' : 'none';
			});
		});

		// Sort by time or name
		sortTypeSelect.addEventListener('change', () => {
			const sortOrder = sortTypeSelect.value;
			const appointmentDays = Array.from(appointmentsContainer.querySelectorAll('.appointment-day'));

			appointmentDays.forEach(day => {
				const appointmentCards = Array.from(day.querySelectorAll('.appointment-card'));

				appointmentCards.sort((a, b) => {
					if (sortOrder === 'time-asc') {
						return a.getAttribute('data-time').localeCompare(b.getAttribute('data-time'));
					} else if (sortOrder === 'time-desc') {
						return b.getAttribute('data-time').localeCompare(a.getAttribute('data-time'));
					} else if (sortOrder === 'name-asc') {
						return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
					} else if (sortOrder === 'name-desc') {
						return b.getAttribute('data-name').localeCompare(a.getAttribute('data-name'));
					}
				});

				appointmentCards.forEach(card => day.appendChild(card));
			});
		});

		// Handle status change via select
		document.querySelectorAll('.status-select').forEach(select => {
			select.addEventListener('change', (event) => {
				const status = event.target.value;
				const appointmentCard = event.target.closest('.appointment-card');
				const slotId = appointmentCard.getAttribute('data-slot-id');
				updateAppointmentStatus(slotId, status, appointmentCard);
			});
		});

		// Handle start examination button
		function startExamination(button) {
			const benhNhanId = button.getAttribute('data-benh-nhan-id');
			const appointmentCard = button.closest('.appointment-card');
			const slotId = appointmentCard.getAttribute('data-slot-id');

			if (!benhNhanId || !slotId) {
				Swal.fire({
					icon: 'error',
					title: 'Lỗi',
					text: 'Không tìm thấy ID bệnh nhân hoặc ID slot. Vui lòng kiểm tra dữ liệu.',
					confirmButtonText: 'Đóng',
					timer: 3000
				});
				return;
			}
			console.log('Redirecting to /bacsi/step1?benhNhanId=' + benhNhanId + '&slotId=' + slotId); // Debug
			window.location.href = `/bacsi/step1?benhNhanId=${benhNhanId}&slotId=${slotId}`;
		}

		// Handle view medical history button
		function viewMedicalHistory(button) {
			const benhNhanId = button.getAttribute('data-benh-nhan-id');
			if (!benhNhanId) {
				Swal.fire({
					icon: 'error',
					title: 'Lỗi',
					text: 'Không tìm thấy ID bệnh nhân. Vui lòng kiểm tra dữ liệu.',
					confirmButtonText: 'Đóng',
					timer: 3000
				});
				return;
			}

			fetch(`/bacsi/medical-history?benhNhanId=${benhNhanId}`, {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => response.json())
				.then(data => {
					if (data && data.length > 0) {
						let htmlContent = '<h3>Lịch sử khám bệnh</h3>';
						data.forEach(record => {
							htmlContent += `
								<div style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
									<h4>Hồ sơ khám: ${record.thoiGianTao}</h4>
									<p><strong>Bệnh nhân:</strong> ${record.benhNhan.ten} (${record.benhNhan.dienThoai})</p>
									<p><strong>Bác sĩ:</strong> ${record.bacSi ? record.bacSi.ten : 'Chưa chỉ định'}</p>
									<p><strong>Chẩn đoán:</strong> ${record.chanDoan || 'Chưa có'}</p>
									<p><strong>Triệu chứng:</strong> ${record.trieuChung || 'Chưa có'}</p>
									<p><strong>Tổng tiền:</strong> ${record.tongTien ? record.tongTien.toLocaleString('vi-VN') + ' VNĐ' : 'Chưa tính'}</p>
									<p><strong>Đã thanh toán:</strong> ${record.daThanhToan ? 'Có' : 'Chưa'}</p>
							`;

							// Vital Signs
							if (record.vitalSigns && record.vitalSigns.length > 0) {
								htmlContent += '<h5>Dấu hiệu sinh tồn:</h5><ul>';
								record.vitalSigns.forEach(vs => {
									htmlContent += `
										<li>
											Thời gian: ${vs.thoiGianTao}<br>
											Nhiệt độ: ${vs.temperature ? vs.temperature + ' °C' : 'Chưa ghi'}<br>
											Chiều cao: ${vs.height ? vs.height + ' cm' : 'Chưa ghi'}<br>
											Cân nặng: ${vs.weight ? vs.weight + ' kg' : 'Chưa ghi'}<br>
											Huyết áp: ${vs.bloodPressureSys && vs.bloodPressureDia ? vs.bloodPressureSys + '/' + vs.bloodPressureDia + ' mmHg' : 'Chưa ghi'}<br>
											Ghi chú: ${vs.notes || 'Không có'}
										</li>
									`;
								});
								htmlContent += '</ul>';
							} else {
								htmlContent += '<p><strong>Dấu hiệu sinh tồn:</strong> Chưa có</p>';
							}

							// Prescriptions
							if (record.donThuocs && record.donThuocs.length > 0) {
								htmlContent += '<h5>Đơn thuốc:</h5><ul>';
								record.donThuocs.forEach(dt => {
									htmlContent += `<li>Đơn thuốc #${dt.donThuocId} (Tổng: ${dt.formattedTongTienThuoc})<ul>`;
									if (dt.donThuocThuocs && dt.donThuocThuocs.length > 0) {
										dt.donThuocThuocs.forEach(dtt => {
											htmlContent += `
												<li>
													Thuốc: ${dtt.thuoc.tenThuoc}<br>
													Liều: ${dtt.lieu || 'Chưa ghi'}<br>
													Tần suất: ${dtt.tanSuat || 'Chưa ghi'}<br>
													Số lượng: ${dtt.soLuong || 'Chưa ghi'}
												</li>
											`;
										});
									} else {
										htmlContent += '<li>Chưa có thuốc</li>';
									}
									htmlContent += '</ul></li>';
								});
								htmlContent += '</ul>';
							} else {
								htmlContent += '<p><strong>Đơn thuốc:</strong> Chưa có</p>';
							}

							// Tests
							if (record.xetNghiems && record.xetNghiems.length > 0) {
								htmlContent += '<h5>Xét nghiệm:</h5><ul>';
								record.xetNghiems.forEach(xn => {
									htmlContent += `
										<li>
											Loại xét nghiệm: ${xn.loaiXetNghiem.tenXetNghiem}<br>
											Giá: ${xn.loaiXetNghiem.gia ? xn.loaiXetNghiem.gia.toLocaleString('vi-VN') + ' VNĐ' : 'Chưa ghi'}<br>
											Trạng thái: ${xn.trangThai || 'Chưa ghi'}<br>
											Ghi chú: ${xn.ghiChu || 'Không có'}<br>
											Kết quả: ${xn.fileKetQua ? `<a href="${xn.fileKetQua}" target="_blank">Xem file</a>` : 'Chưa có'}
										</li>
									`;
								});
								htmlContent += '</ul>';
							} else {
								htmlContent += '<p><strong>Xét nghiệm:</strong> Chưa có</p>';
							}

							// Test Forms
							if (record.phieuXetNghiems && record.phieuXetNghiems.length > 0) {
								htmlContent += '<h5>Phiếu xét nghiệm:</h5><ul>';
								record.phieuXetNghiems.forEach(pxn => {
									htmlContent += `
										<li>
											Mã phiếu: ${pxn.maPhieu}<br>
											Tổng giá: ${pxn.tongGia ? pxn.tongGia.toLocaleString('vi-VN') + ' VNĐ' : 'Chưa tính'}<br>
											Thời gian tạo: ${pxn.thoiGianTao}<br>
											Xét nghiệm: ${pxn.xetNghiemIds ? pxn.xetNghiemIds.join(', ') : 'Chưa có'}
										</li>
									`;
								});
								htmlContent += '</ul>';
							} else {
								htmlContent += '<p><strong>Phiếu xét nghiệm:</strong> Chưa có</p>';
							}

							htmlContent += '</div>';
						});

						Swal.fire({
							title: 'Lịch sử khám bệnh',
							html: htmlContent,
							width: '800px',
							showCloseButton: true,
							confirmButtonText: 'Đóng',
							customClass: {
								popup: 'swal-wide'
							}
						});
					} else {
						Swal.fire({
							icon: 'info',
							title: 'Không có dữ liệu',
							text: 'Bệnh nhân này chưa có lịch sử khám bệnh.',
							confirmButtonText: 'Đóng',
							timer: 3000
						});
					}
				})
				.catch(error => {
					console.error('Lỗi khi lấy lịch sử khám:', error);
					Swal.fire({
						icon: 'error',
						title: 'Có lỗi xảy ra',
						text: 'Không thể tải lịch sử khám. Vui lòng thử lại sau.',
						confirmButtonText: 'Đóng',
						timer: 3000
					});
				});
		}

		function updateAppointmentStatus(slotId, status, appointmentCard) {
			fetch('/bacsi/update-appointment-status', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					slotId: slotId,
					status: status
				})
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						Swal.fire({
							icon: 'success',
							title: 'Cập nhật thành công',
							text: 'Trạng thái lịch khám đã được cập nhật.',
							confirmButtonText: 'Đóng',
							timer: 3000
						});
						// Update the button's disabled state
						const startExamButton = appointmentCard.querySelector('.start-exam-btn');
						const benhNhanId = startExamButton.getAttribute('data-benh-nhan-id');
						startExamButton.disabled = !(status === 'pending' && benhNhanId);
					} else {
						Swal.fire({
							icon: 'error',
							title: 'Có lỗi xảy ra',
							text: 'Vui lòng thử lại sau.',
							confirmButtonText: 'Đóng',
							timer: 3000
						});
					}
				})
				.catch(error => {
					console.error('Lỗi khi cập nhật trạng thái:', error);
					Swal.fire({
						icon: 'error',
						title: 'Có lỗi xảy ra',
						text: 'Vui lòng thử lại sau.',
						confirmButtonText: 'Đóng',
						timer: 3000
					});
				});
		}
	</script>
</body>

</html>