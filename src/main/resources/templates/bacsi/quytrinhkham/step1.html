<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khám Bệnh - Bước 1</title>
    <link rel="stylesheet" th:href="@{/css/xemlichhen.css}">
    <link rel="stylesheet" th:href="@{/css/headerbacsi.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Your existing CSS styles remain unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e6f0fa 0%, #d1e3fa 100%);
            color: #2d3748;
            line-height: 1.6;
            padding: 90px 20px 20px !important;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 50, 100, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .container:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0, 50, 100, 0.2);
        }

        .patient-info,
        .vital-signs {
            margin-bottom: 30px;
        }

        .patient-info h2,
        .vital-signs h2 {
            color: #2563eb;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }

        .patient-info p {
            margin: 10px 0;
            font-size: 16px;
            display: flex;
        }

        .patient-info p strong {
            color: #4a5568;
            width: 180px;
            font-weight: 600;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #d1e3fa;
            margin-bottom: 25px;
            background: #e6f0fa;
            border-radius: 12px;
            padding: 5px;
        }

        .tab-nav button {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .tab-nav button.active {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            background: #f8fafc;
        }

        .tab-nav button:hover:not(.active) {
            color: #3b82f6;
            background: #d1e3fa;
        }

        .tab-nav button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 50, 100, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1e3fa;
            border-radius: 10px;
            font-size: 15px;
            background: #f8fafc;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 50, 100, 0.1);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            background: #fff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .save-btn {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .save-btn i {
            margin-right: 8px;
        }

        .error-message {
            color: #721c24;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        @media (max-width: 600px) {
            body {
                padding-top: 70px !important;
            }

            .container {
                padding: 20px;
                margin: 20px auto;
            }

            .patient-info h2,
            .vital-signs h2 {
                font-size: 1.5rem;
            }

            .patient-info p {
                font-size: 14px;
            }

            .patient-info p strong {
                width: 140px;
            }

            .tab-nav button {
                font-size: 14px;
                padding: 10px;
            }

            .form-group input,
            .form-group textarea {
                font-size: 14px;
                padding: 10px;
            }

            .save-btn {
                font-size: 15px;
                padding: 10px 20px;
            }
        }
    </style>
</head>

<body>
    <div th:replace="bacsi/fragments/header :: header"></div>

    <div class="container">
        <div class="patient-info">
            <h2>Thông tin bệnh nhân</h2>
            <p><strong>Họ và tên:</strong> <span th:text="${benhNhan?.ten ?: 'Không có'}"></span></p>
            <p><strong>Số điện thoại:</strong> <span th:text="${benhNhan?.dienThoai ?: 'Không có'}"></span></p>
            <p><strong>Ngày sinh:</strong> <span th:text="${benhNhan?.ngaySinh ?: 'Không có'}"></span></p>
            <p><strong>Giới tính:</strong> <span th:text="${benhNhan?.gioiTinh ?: 'Không có'}"></span></p>
            <p><strong>Địa chỉ:</strong> <span th:text="${benhNhan?.diaChi ?: 'Không có'}"></span></p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="tab1">Bước 1: Thông số y tế</button>
            <button class="tab-btn" data-tab="tab2" disabled
                th:data-url="@{/bacsi/step2(benhNhanId=${benhNhan?.benhNhanId},hoSoId=${hoSoBenh?.hoSoId},slotId=${slotId})}"
                onclick="checkTabSwitch(this)">
                Bước 2: Chẩn đoán & Xét nghiệm
            </button>
            <button class="tab-btn" data-tab="tab3" disabled
                th:data-url="@{/bacsi/step3(benhNhanId=${benhNhan?.benhNhanId},hoSoId=${hoSoBenh?.hoSoId},slotId=${slotId})}"
                onclick="checkTabSwitch(this)">
                Bước 3: Kê đơn
            </button>
        </div>

        <div class="tab-content active" id="tab1">
            <div class="vital-signs">
                <h2>Thông số y tế</h2>
                <form id="vital-signs-form" th:action="@{/bacsi/step1/save}" method="post">
                    <input type="hidden" name="benhNhanId" th:value="${benhNhan?.benhNhanId}">
                    <input type="hidden" name="hoSoId" th:value="${hoSoBenh?.hoSoId}">
                    <input type="hidden" name="maLichKhamBenh" th:value="${maLichKhamBenh}">
                    <div class="form-group">
                        <label for="trieuChung">Triệu chứng:</label>
                        <textarea id="trieuChung" name="trieuChung"
                            placeholder="Nhập triệu chứng (VD: sốt, ho, đau họng)..."
                            th:text="${hoSoBenh?.trieuChung}" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="nhietDo">Nhiệt độ (°C):</label>
                        <input type="number" step="0.1" id="nhietDo" name="nhietDo"
                            th:value="${vitalSigns?.temperature}" placeholder="Nhập nhiệt độ..." required>
                    </div>
                    <div class="form-group">
                        <label for="chieuCao">Chiều cao (cm):</label>
                        <input type="number" step="0.1" id="chieuCao" name="chieuCao" th:value="${vitalSigns?.height}"
                            placeholder="Nhập chiều cao..." required>
                    </div>
                    <div class="form-group">
                        <label for="canNang">Cân nặng (kg):</label>
                        <input type="number" step="0.1" id="canNang" name="canNang" th:value="${vitalSigns?.weight}"
                            placeholder="Nhập cân nặng..." required>
                    </div>
                    <div class="form-group">
                        <label for="bloodPressureSys">Huyết áp tâm thu (mmHg):</label>
                        <input type="number" id="bloodPressureSys" name="bloodPressureSys"
                            th:value="${vitalSigns?.bloodPressureSys}" placeholder="Nhập huyết áp tâm thu..." required>
                    </div>
                    <div class="form-group">
                        <label for="bloodPressureDia">Huyết áp tâm trương (mmHg):</label>
                        <input type="number" id="bloodPressureDia" name="bloodPressureDia"
                            th:value="${vitalSigns?.bloodPressureDia}" placeholder="Nhập huyết áp tâm trương..." required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi chú:</label>
                        <input type="text" id="notes" name="notes" th:value="${vitalSigns?.notes}"
                            placeholder="Nhập ghi chú...">
                    </div>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Lưu và tiếp tục
                    </button>
                </form>
            </div>
        </div>
        <div class="tab-content" id="tab2">
            <h2>Bước 2</h2>
            <p>Nội dung bước 2 sẽ được tải khi hoàn tất bước 1.</p>
        </div>
        <div class="tab-content" id="tab3">
            <h2>Bước 3</h2>
            <p>Nội dung bước 3 sẽ được thêm sau.</p>
        </div>
    </div>

    <script>
        let isFormSaved = false;
        let isFormDirty = false;

        // Track form changes
        const form = document.getElementById('vital-signs-form');
        const inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                isFormDirty = true;
            });
        });

        // Validate form fields
        function validateForm() {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#721c24';
                } else {
                    field.style.borderColor = '#d1e3fa';
                }
            });
            return isValid;
        }

        // Enable tabs after successful save
        function enableTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn[data-tab="tab2"], .tab-btn[data-tab="tab3"]');
            tabButtons.forEach(button => {
                button.disabled = false;
            });
        }

        // Check if user tries to switch tabs without saving
        function checkTabSwitch(button) {
            if (isFormDirty && !isFormSaved) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa lưu thông tin',
                    text: 'Vui lòng lưu thông tin trước khi chuyển tab.',
                    showCancelButton: true,
                    confirmButtonText: 'Lưu và tiếp tục',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Trigger form submission
                        form.dispatchEvent(new Event('submit'));
                    }
                });
            } else if (isFormSaved) {
                redirectToStep(button);
            }
        }

        // Redirect to step
        function redirectToStep(button) {
            const url = button.getAttribute('data-url');
            console.log('Redirecting to:', url);
            if (!url) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'URL chuyển hướng không tồn tại.',
                    confirmButtonText: 'Đóng'
                });
                return;
            }
            const urlParams = new URLSearchParams(url.split('?')[1]);
            const benhNhanId = urlParams.get('benhNhanId');
            const hoSoId = urlParams.get('hoSoId');
            if (benhNhanId === 'null' || hoSoId === 'null') {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: `Thông tin không hợp lệ: benhNhanId=${benhNhanId}, hoSoId=${hoSoId}`,
                    confirmButtonText: 'Đóng'
                });
                return;
            }
            window.location.href = url;
        }

        // Form submission with validation
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            if (!validateForm()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Vui lòng điền đầy đủ các trường bắt buộc.',
                    confirmButtonText: 'Đóng'
                });
                return;
            }

            const formData = new FormData(this);
            const urlParams = new URLSearchParams(window.location.search);
            const slotId = urlParams.get('slotId');

            const data = {
                hoSoId: formData.get('hoSoId'),
                benhNhanId: formData.get('benhNhanId'),
                slotId: slotId,
                trieuChung: formData.get('trieuChung'),
                nhietDo: formData.get('nhietDo'),
                chieuCao: formData.get('chieuCao'),
                canNang: formData.get('canNang'),
                bloodPressureSys: formData.get('bloodPressureSys'),
                bloodPressureDia: formData.get('bloodPressureDia'),
                notes: formData.get('notes')
            };

            if (!slotId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Mã lịch khám không được tìm thấy trong URL.',
                    confirmButtonText: 'Đóng'
                });
                return;
            }

            fetch('/bacsi/step1/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isFormSaved = true;
                        isFormDirty = false;
                        enableTabs();
                        Swal.fire({
                            icon: 'success',
                            title: 'Lưu thành công',
                            text: 'Chuyển sang bước 2...',
                            confirmButtonText: 'Đóng'
                        }).then(() => {
                            window.location.href = data.redirectUrl;
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: data.message || 'Vui lòng thử lại.',
                            confirmButtonText: 'Đóng'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Vui lòng thử lại.',
                        confirmButtonText: 'Đóng'
                    });
                });
        });
    </script>
</body>

</html>