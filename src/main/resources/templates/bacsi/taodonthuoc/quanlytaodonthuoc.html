<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Thuốc</title>
    <link th:href="@{/css/headerbacsi.css}" rel="stylesheet">
    <link th:href="@{/css/quanlytaodonthuoc.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.10/dist/sweetalert2.all.min.js"></script>
</head>

<body>
    <div th:replace="bacsi/fragments/header :: header"></div>

    <div class="container">
        <h1>Quản Lý Đơn Thuốc</h1>

        <!-- Form tìm kiếm bệnh nhân và lọc theo ngày -->
        <div class="search-filter">
            <form method="get" th:action="@{/bacsi/quanlytaodonthuoc}">
                <label for="phone">Nhập SĐT bệnh nhân:</label>
                <input type="text" id="phone" name="phone" placeholder="Nhập số điện thoại..." th:value="${phone}" required>
                
                <label for="filter-date">Lọc theo ngày:</label>
                <input type="date" id="filter-date" name="filterDate" th:value="${filterDate}">
                
                <button type="submit">Tìm Kiếm</button>
            </form>

            <!-- Nút tạo đơn thuốc (luôn hiển thị) -->
            <div class="create-prescription">
                <a th:href="@{/bacsi/taodonthuoc}" class="btn-create">
                    Tạo Đơn Thuốc
                </a>
            </div>
        </div>

        <div class="content-wrapper" th:if="${selectedBenhNhan != null}">
            <!-- Thông tin bệnh nhân -->
            <div class="patient-info">
                <h2>Thông Tin Bệnh Nhân</h2>
                <p><strong>Tên:</strong> <span th:text="${selectedBenhNhan.ten}"></span></p>
                <p><strong>Ngày Sinh:</strong> <span th:text="${selectedBenhNhan.ngaySinh}"></span></p>
                <p><strong>Giới Tính:</strong> <span th:text="${selectedBenhNhan.gioiTinh}"></span></p>
                <p><strong>Địa Chỉ:</strong> <span th:text="${selectedBenhNhan.diaChi}"></span></p>
                <p><strong>Số Điện Thoại:</strong> <span th:text="${selectedBenhNhan.dienThoai}"></span></p>
            </div>

            <!-- Lịch sử đơn thuốc -->
            <div class="history" th:if="${not #lists.isEmpty(donThuocs)}">
                <h2>Lịch Sử Đơn Thuốc</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Ngày Khám</th>
                            <th>Chẩn Đoán</th>
                            <th>Triệu Chứng</th>
                            <th>Bác Sĩ</th>
                            <th>Thuốc Kê Đơn</th>
                            <th>Liều Lượng</th>
                            <th>Tần Suất</th>
                            <th>Số Lượng</th>
                            <th>Tổng Tiền</th>
                            <th>Hành Động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="donThuoc : ${donThuocs}">
                            <td th:text="${donThuoc.formattedDate}"></td>
                            <td th:text="${donThuoc.hoSoBenh.chanDoan}"></td>
                            <td th:text="${donThuoc.hoSoBenh.trieuChung}"></td>
                            <td th:text="${donThuoc.hoSoBenh.bacSi.ten}"></td>
                            <td>
                                <ul class="medicine-list">
                                    <li th:each="thuoc : ${donThuoc.donThuocThuocs}" th:text="${thuoc.thuoc.ten}"></li>
                                </ul>
                            </td>
                            <td>
                                <ul class="medicine-list">
                                    <li th:each="thuoc : ${donThuoc.donThuocThuocs}" th:text="${thuoc.lieu}"></li>
                                </ul>
                            </td>
                            <td>
                                <ul class="medicine-list">
                                    <li th:each="thuoc : ${donThuoc.donThuocThuocs}" th:text="${thuoc.tanSuat}"></li>
                                </ul>
                            </td>
                            <td>
                                <ul class="medicine-list">
                                    <li th:each="thuoc : ${donThuoc.donThuocThuocs}" th:text="${thuoc.soLuong}"></li>
                                </ul>
                            </td>
                            <td th:text="${donThuoc.formattedTongTienThuoc}"></td>
                            <td>
                                <form th:action="@{|/bacsi/xoadonthuoc/${donThuoc.donThuocId}|}" method="post">
                                    <button type="submit" onclick="return confirm('Bạn có chắc chắn muốn xóa đơn thuốc này?')">Xóa</button>
                                </form>
                                <a th:href="@{|/bacsi/capnhatdonthuoc?id=${donThuoc.donThuocId}|}" class="edit-button">Sửa</a>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Phân trang -->
                <div class="pagination" th:if="${totalPages > 1}">
                    <ul>
                        <li th:if="${currentPage > 0}">
                            <a th:href="@{/bacsi/quanlytaodonthuoc(phone=${phone}, filterDate=${filterDate}, page=${currentPage - 1})}">« Trước</a>
                        </li>

                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                            <a th:href="@{/bacsi/quanlytaodonthuoc(phone=${phone}, filterDate=${filterDate}, page=${i})}" 
                               th:text="${i + 1}" 
                               th:classappend="${i == currentPage} ? 'active' : ''">
                            </a>
                        </li>

                        <li th:if="${currentPage < totalPages - 1}">
                            <a th:href="@{/bacsi/quanlytaodonthuoc(phone=${phone}, filterDate=${filterDate}, page=${currentPage + 1})}">Sau »</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let successMessage = /*[[${successMessage}]]*/ null;
        if (successMessage) {
            Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: successMessage,
                confirmButtonText: 'OK'
            });
        }

        let errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            Swal.fire({
                icon: 'error',
                title: 'Thất bại!',
                text: errorMessage,
                confirmButtonText: 'OK'
            });
        }
    </script>
</body>

</html>
